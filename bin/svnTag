#!/bin/bash
#
# File: svnTag
# Author: ChrisAlbrecht
# Description: Tag a Drupal module or theme for release by copying the trunk
#   into the tags directory.

PRE="svnTag:"

# First make sure we are in a drupal root directory
if [ ! -f *.info ]; then
  echo "$PRE You are not in a drupal root directory.  Tag cannot be made."
  exit 1
fi

# Make sure the info files are up to date.
read -p "$PRE Is the version number updated in all .info files (y/n)? " X

if [ "$X" != 'y' ]; then
  echo "Update versions first.  Tag not made."
  exit 1
fi

DATA=`svn info --xml`
URL=`expr "$DATA" : '.*\(\<url\>.*\</url\>\)'`

# Strip the tags
URL=${URL/<url>/}
URL=${URL/<\/url>/}

if [ ${URL:(-5)} == "trunk" ]; then
  TRUNK=$URL
  TAGS=${URL/%trunk/tags}
fi

# Get the version
while read line
do
  if [ "${line:0:4}" == "name" ]; then
    NAME=${line}
  fi

  if [ "${line:0:7}" == "version" ]; then
    VERSION=${line}
  fi
done < *.info

# Strip off the name text so we are left with just the project name
NAME=${NAME/name = /}
NAME=${NAME/name=/}
NAME=${NAME//\"/}

# Strip off the version text so we are left with just the version number
VERSION=${VERSION/version = /}
VERSION=${VERSION/version=/}
VERSION=${VERSION//\"/}
VERSION=${VERSION:4}

# Make sure we have all the necessary data to move forward
if [ -z "$TRUNK" ] || [ -z "$TAGS" ] || [ -z "$NAME" ] || [ -z "$VERSION" ]; then
  echo "$PRE Unable to gather the necessary data to tag this project."
  echo "$PRE TRUNK=$TRUNK, TAGS=$TAGS, NAME=$NAME, VERSION=$VERSION"
  exit 1
fi

echo "$PRE Tagging $NAME for release ($VERSION)."
svn copy $TRUNK $TAGS/$VERSION -m "Tagging $NAME for release ($VERSION)."
